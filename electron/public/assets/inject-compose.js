const fs = require('fs');
const path = require('path');

// Patch the bundle that gets served (public/assets/), not just electron/public/assets/
const bundlePath = path.join(__dirname, '../../../public/assets/index-CPfyPHiu.js');
const backupPath = path.join(__dirname, '../../../public/assets/index-CPfyPHiu.js.bak');

// Restore from backup if --restore flag
if (process.argv.includes('--restore')) {
  if (fs.existsSync(backupPath)) {
    fs.copyFileSync(backupPath, bundlePath);
    console.log('Restored bundle from backup.');
  } else {
    console.error('No backup found at', backupPath);
    process.exit(1);
  }
  process.exit(0);
}

let s = fs.readFileSync(bundlePath, 'utf8');

// Backup before first patch (only if no backup exists)
if (!fs.existsSync(backupPath)) {
  fs.writeFileSync(backupPath, s);
  console.log('Created backup at', backupPath);
}

// zWCompose = Compose page with Section 1 (Send Now) + Section 2 (Bulk Schedule)
const zW = `zWCompose=()=>{const[e,t]=x.useState(""),[g,G]=x.useState(""),[n,r]=x.useState([]),[a,i]=x.useState(!0),[o,l]=x.useState(!1),[s,c]=x.useState(""),[d,u]=x.useState(""),[F,H]=x.useState(null),[B,C]=x.useState([]),[D,E]=x.useState(!0),[J,K]=x.useState(""),[L,M]=x.useState(!1),[N,O]=x.useState({}),[P,Q]=x.useState(""),[R,S]=x.useState(""),[T,U]=x.useState(!1),[V,W]=x.useState(""),[X,Y]=x.useState(""),[Z,aa]=x.useState("");const ref=()=>{E(!0);fetch("/api/posting/jobs").then(r=>r.json()).then(r=>{C(r.jobs||[]);E(!1)}).catch(()=>E(!1))};x.useEffect(()=>{l(!1);i(!0);fetch("/api/groups").then(e=>e.json()).then(e=>{r(Array.isArray(e)?e.map(e=>({name:e.group_name||e.name||""})):[]);i(!1)}).catch(()=>{i(!1)})},[]);x.useEffect(()=>{ref()},[]);const m=()=>{if(!e.trim()&&!F)return void c("Enter a message or attach an image");if(!g)return void c("Select a group");c("");u("");l(!0);const run=resp=>resp.json().then(j=>{l(!1);j.success?(u("Message sent."),t(""),H(null)):c(j.error||"Send failed")}).catch(()=>{l(!1);c("Request failed")});const fail=()=>{l(!1);c("Request failed")};if(F){const fd=new FormData();fd.append("image",F);fd.append("messageText",e.trim());fd.append("groupName",g);fetch("/api/posting/send-now",{method:"POST",body:fd}).then(run).catch(fail)}else{fetch("/api/posting/send-now",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messageText:e.trim(),groupName:g})}).then(run).catch(fail)}};const prev=()=>{if(!J.trim())return void c("Paste CSV or upload a file");c("");fetch("/api/posting/import/csv-preview",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({csvText:J})}).then(r=>r.json()).then(j=>{if(j.success){const v=j.validation.filter(vv=>vv.valid).length,inv=j.validation.filter(vv=>!vv.valid);u(v+" valid rows"+(inv.length?"; "+inv.length+" errors":"")+(inv.length?": "+inv.slice(0,3).map(vv=>"row "+vv.rowNumber+": "+vv.error).join("; "):""))}else c(j.error||"Preview failed")}).catch(()=>c("Preview failed"));};const imp=()=>{if(!J.trim())return void c("Paste CSV or upload a file");c("");M(!0);fetch("/api/posting/import/csv",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({csvText:J})}).then(r=>r.json()).then(j=>{M(!1);j.success?(K(""),u("Imported "+j.createdCount+" jobs."),ref()):c(j.error||"Import failed")}).catch(()=>{M(!1);c("Import failed")})};const add=()=>{if(!V.trim())return void c("Enter message");if(!X.trim())return void c("Enter group");let dt=new Date();dt.setDate(dt.getDate()+1);dt.setHours(10,0,0,0);const pad=n=>n<10?"0"+n:""+n,def=dt.getFullYear()+"-"+pad(dt.getMonth()+1)+"-"+pad(dt.getDate())+"T"+pad(dt.getHours())+":"+pad(dt.getMinutes());const sched=Z||def;c("");fetch("/api/posting/jobs",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rows:[{messageText:V.trim(),groupName:X.trim(),scheduledAt:sched}]})}).then(r=>r.json()).then(j=>{if(j.success){W("");Y("");aa("");u("Added 1 job.");ref()}else c(j.error||"Add failed")}).catch(()=>c("Add failed"));};const del=(id)=>{fetch("/api/posting/jobs/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ids:[id]})}).then(r=>r.json()).then(j=>{if(j.success){u("Deleted.");ref()}}).catch(()=>c("Delete failed"));};const enq=(id)=>{fetch("/api/posting/jobs/enqueue",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ids:[id]})}).then(r=>r.json()).then(j=>{if(j.success){u("Queued.");ref()}else c(j.error||"Enqueue failed")}).catch(()=>c("Enqueue failed"));};const rand=()=>{const ids=Object.keys(N).filter(id=>N[id]);if(!ids.length)return void c("Select at least one job");if(!P||!R)return void c("Enter start and end time");c("");U(!0);fetch("/api/posting/jobs/randomize-times",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ids:ids.map(Number),startAt:P,endAt:R})}).then(r=>r.json()).then(j=>{U(!1);if(j.success){O({});u("Randomized "+j.jobs.length+" jobs.");ref()}else c(j.error||"Randomize failed")}).catch(()=>{U(!1);c("Randomize failed")});};const MUT=[ "uploaded","queued","scheduled","failed","cancelled"];const toggle=(id)=>{O(prev=>{const n={...prev};n[id]?delete n[id]:n[id]=!0;return n})};const allMut=B.filter(b=>MUT.includes(b.status));const selAll=()=>{const n={};allMut.forEach(b=>n[b.id]=!0);O(n)};const clr=()=>O({});const st=(m)=>{const g={uploaded:"bg-slate-100 text-slate-700",queued:"bg-blue-50 text-blue-700",scheduled:"bg-purple-50 text-purple-700",sent:"bg-emerald-50 text-emerald-700",failed:"bg-red-50 text-red-700",cancelled:"bg-gray-50 text-gray-700"};return g[m]||g.uploaded};const fmt=(d)=>d?new Date(d).toLocaleString():"";return p.jsxs("div",{className:"animate-fade-in",children:[p.jsxs("div",{className:"mb-10",children:[p.jsx("h2",{className:"text-3xl font-bold text-[#002060]",children:"Compose"}),p.jsx("p",{className:"text-slate-500 mt-1",children:"Send a message or image to a group."})]}),s?p.jsx("div",{className:"rounded border border-red-200 bg-red-50 text-red-700 px-4 py-3 mb-4",children:s}):null,d?p.jsx("div",{className:"rounded border border-emerald-200 bg-emerald-50 text-emerald-700 px-4 py-3 mb-4",children:d}):null,p.jsxs("div",{className:"bg-white rounded border border-slate-100 shadow-[0_2px_10px_-3px_rgba(6,81,237,0.1)] p-8 max-w-2xl mb-10",children:[p.jsxs("div",{className:"mb-4",children:[p.jsx("label",{className:"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2",children:"Message (optional caption for image)"}),p.jsx("textarea",{className:"w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded focus:ring-2 focus:ring-[#00a0e9]/20 focus:border-[#00a0e9] outline-none",value:e,onChange:ev=>t(ev.target.value),placeholder:"Type your message or caption...",rows:5})]}),p.jsxs("div",{className:"mb-4",children:[p.jsx("label",{className:"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2",children:"Image"}),p.jsxs("div",{className:"flex items-center gap-3",children:[p.jsx("input",{type:"file",accept:"image/*",className:"text-sm text-slate-600",onChange:ev=>{const f=ev.target.files?.[0];H(f||null)}}),F?p.jsxs("span",{className:"text-sm text-slate-600",children:[F.name," ",p.jsx("button",{type:"button",className:"ml-2 text-red-600 hover:underline",onClick:()=>H(null),children:"Clear"})]}):null]})]}),p.jsxs("div",{className:"mb-6",children:[p.jsx("label",{className:"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2",children:"Group"}),p.jsx("select",{className:"w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded focus:ring-2 focus:ring-[#00a0e9]/20 focus:border-[#00a0e9] outline-none",value:g,onChange:ev=>G(ev.target.value),disabled:a,children:[p.jsx("option",{value:"",children:"Select a group"}),...n.map(v=>p.jsx("option",{key:v.name,value:v.name,children:v.name}))]})]}),p.jsx("button",{type:"button",className:"px-6 py-2.5 bg-[#002060] text-white font-medium rounded hover:opacity-90 disabled:opacity-50",onClick:m,disabled:o||a,children:o?p.jsxs("span",{className:"inline-flex items-center gap-2",children:["Sending...",p.jsx("span",{className:"animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full",children:null})]}):p.jsxs("span",{className:"inline-flex items-center gap-2",children:[p.jsx(T3,{})," Send"]})})]})),p.jsxs("div",{className:"mb-8",children:[p.jsx("h3",{className:"text-lg font-bold text-[#002060] mb-4",children:"Bulk Schedule"}),p.jsxs("div",{className:"mb-4",children:[p.jsx("label",{className:"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2",children:"CSV Import"}),p.jsx("input",{type:"file",accept:".csv,text/csv",className:"mb-2 text-sm",onChange:ev=>{const f=ev.target.files?.[0];if(f){const fr=new FileReader();fr.onload=()=>K(fr.result||"");fr.readAsText(f)}}}),p.jsx("textarea",{className:"w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded focus:ring-2 focus:ring-[#00a0e9]/20 text-sm font-mono",value:J,onChange:ev=>K(ev.target.value),placeholder:"Paste CSV. Headers: row_id, group_name, scheduled_at, message_text",rows:4}),p.jsxs("div",{className:"flex gap-2 mt-2",children:[p.jsx("button",{type:"button",className:"px-4 py-2 bg-slate-200 text-slate-700 rounded hover:bg-slate-300 text-sm",onClick:prev,disabled:!J.trim(),children:"Preview"}),p.jsx("button",{type:"button",className:"px-4 py-2 bg-[#002060] text-white rounded hover:opacity-90 disabled:opacity-50 text-sm",onClick:imp,disabled:L||!J.trim(),children:L?"Importing...":"Import"}),p.jsx("button",{type:"button",className:"px-4 py-2 bg-slate-200 text-slate-700 rounded hover:bg-slate-300 text-sm",onClick:()=>K(""),children:"Clear"})]})]}),p.jsxs("div",{className:"mb-4",children:[p.jsx("label",{className:"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2",children:"Add Row"}),p.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[p.jsx("textarea",{className:"px-3 py-2 bg-slate-50 border border-slate-200 rounded text-sm",value:V,onChange:ev=>W(ev.target.value),placeholder:"Message",rows:2}),p.jsx("input",{type:"text",className:"px-3 py-2 bg-slate-50 border border-slate-200 rounded text-sm",value:X,onChange:ev=>Y(ev.target.value),placeholder:"Group name"}),p.jsxs("div",{className:"flex gap-2",children:[p.jsx("input",{type:"datetime-local",className:"px-3 py-2 bg-slate-50 border border-slate-200 rounded text-sm flex-1",value:Z,onChange:ev=>aa(ev.target.value),placeholder:"Scheduled"}),p.jsx("button",{type:"button",className:"px-4 py-2 bg-[#002060] text-white rounded hover:opacity-90 text-sm whitespace-nowrap",onClick:add,children:"Add"})]})]})]}),p.jsxs("div",{className:"mb-4 p-4 bg-slate-50 rounded border border-slate-100",children:[p.jsx("label",{className:"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2",children:"Randomize send times"}),p.jsxs("div",{className:"flex flex-wrap gap-3 items-end",children:[p.jsxs("div",{children:[p.jsx("span",{className:"text-xs text-slate-500 mr-1",children:"Start"}),p.jsx("input",{type:"datetime-local",className:"px-3 py-2 bg-white border border-slate-200 rounded text-sm",value:P,onChange:ev=>Q(ev.target.value)})]}),p.jsxs("div",{children:[p.jsx("span",{className:"text-xs text-slate-500 mr-1",children:"End"}),p.jsx("input",{type:"datetime-local",className:"px-3 py-2 bg-white border border-slate-200 rounded text-sm",value:R,onChange:ev=>S(ev.target.value)})]}),p.jsx("button",{type:"button",className:"px-3 py-2 bg-slate-200 text-slate-700 rounded hover:bg-slate-300 text-sm",onClick:selAll,children:"Select all"}),p.jsx("button",{type:"button",className:"px-3 py-2 bg-slate-200 text-slate-700 rounded hover:bg-slate-300 text-sm",onClick:clr,children:"Clear"}),p.jsx("button",{type:"button",className:"px-4 py-2 bg-[#002060] text-white rounded hover:opacity-90 disabled:opacity-50 text-sm",onClick:rand,disabled:T||!Object.keys(N).some(k=>N[k]),children:T?"Randomizing...":"Randomize times"})]})]}),D?p.jsx("div",{className:"py-8 text-center text-slate-500",children:"Loading jobs..."}):p.jsxs("div",{className:"overflow-x-auto",children:[p.jsxs("table",{className:"w-full text-left border-collapse text-sm",children:[p.jsx("thead",{children:p.jsxs("tr",{className:"bg-slate-50 text-slate-500 text-xs uppercase",children:[p.jsx("th",{className:"px-4 py-3",children:"Select"}),p.jsx("th",{className:"px-4 py-3",children:"Message"}),p.jsx("th",{className:"px-4 py-3",children:"Group"}),p.jsx("th",{className:"px-4 py-3",children:"Scheduled"}),p.jsx("th",{className:"px-4 py-3",children:"Status"}),p.jsx("th",{className:"px-4 py-3",children:"Type"}),p.jsx("th",{className:"px-4 py-3 text-right",children:"Actions"})]})}),p.jsx("tbody",{className:"divide-y divide-slate-100",children:B.length>0?B.map(b=>{const mut=MUT.includes(b.status);return p.jsxs("tr",{key:b.id,className:"hover:bg-slate-50",children:[p.jsx("td",{className:"px-4 py-3",children:mut?p.jsx("input",{type:"checkbox",checked:!!N[b.id],onChange:()=>toggle(b.id)}):null}),p.jsx("td",{className:"px-4 py-3 max-w-xs truncate",title:b.messageText,children:b.messageText||"-"}),p.jsx("td",{className:"px-4 py-3",children:b.resolvedGroup?.name||b.groupName||"-"}),p.jsx("td",{className:"px-4 py-3",children:fmt(b.scheduledAt)}),p.jsx("td",{className:"px-4 py-3",children:p.jsx("span",{className:"px-2 py-0.5 rounded text-xs font-bold "+st(b.status),children:b.status})}),p.jsx("td",{className:"px-4 py-3",children:p.jsx("span",{className:"inline-flex px-2 py-0.5 rounded text-xs "+(b.deliveryType==="compose"?"bg-cyan-50 text-cyan-700":"bg-slate-100 text-slate-700"),children:b.deliveryType==="compose"?"Compose":"Scheduled"})}),p.jsx("td",{className:"px-4 py-3 text-right",children:p.jsxs("div",{className:"flex gap-2 justify-end",children:[mut&&p.jsx("button",{type:"button",className:"text-xs px-2 py-1 bg-blue-50 text-blue-700 rounded hover:bg-blue-100",onClick:()=>enq(b.id),children:"Enqueue"}),p.jsx("button",{type:"button",className:"text-xs px-2 py-1 bg-red-50 text-red-700 rounded hover:bg-red-100",onClick:()=>confirm("Delete?")&&del(b.id),children:"Delete"})]})})]},b.id)}):p.jsx("tr",{children:p.jsx("td",{colSpan:7,className:"px-6 py-8 text-center text-slate-400",children:"No jobs. Import CSV or add a row."})})})]})]})]})]})}`;

// Replace entire zWCompose definition (from zWCompose= to },uW=) with our enhanced version
// Match current version for re-patch (with Section 2 bulk schedule)
const oldComposeStart = 'zWCompose=()=>{const[e,t]=x.useState(""),[g,G]=x.useState(""),[n,r]=x.useState([]),[a,i]=x.useState(!0),[o,l]=x.useState(!1),[s,c]=x.useState(""),[d,u]=x.useState(""),[F,H]=x.useState(null),[B,C]=x.useState([]),[D,E]=x.useState(!0),[J,K]=x.useState("")';
const idx = s.indexOf(oldComposeStart);
if (idx < 0) {
  console.error('zWCompose start not found in bundle');
  process.exit(1);
}
// Find },uW= which marks the end of zWCompose (unique in bundle)
const endMark = '},uW=';
const endIdx = s.indexOf(endMark, idx);
if (endIdx < 0) {
  console.error('Could not find zWCompose end (},uW=) in bundle');
  process.exit(1);
}
const before = s.substring(0, idx);
const after = s.substring(endIdx + 1); // keep ',uW=' for next component
s = before + zW + after;
fs.writeFileSync(bundlePath, s);
console.log('Compose component (zW) injected successfully.');
